name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Test
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Test frontend build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
        env:
          VITE_CESIUM_TOKEN: ${{ secrets.VITE_CESIUM_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Test backend
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          python -c "from main import app; print('✓ Backend OK')"

  # ===========================================================================
  # Build Docker Image
  # ===========================================================================
  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build \
            --build-arg VITE_CESIUM_TOKEN=${{ secrets.VITE_CESIUM_TOKEN }} \
            -t sat-sim:latest \
            -t sat-sim:${{ github.sha }} \
            -f backend/Dockerfile \
            .
          docker save sat-sim:latest | gzip > app-image.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: app-image.tar.gz
          retention-days: 1

  # ===========================================================================
  # Deploy to Kubernetes (on Lightsail)
  # ===========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          scp -i ~/.ssh/lightsail_key \
            app-image.tar.gz \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}:/tmp/
          scp -i ~/.ssh/lightsail_key -r \
            k8s \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}:/tmp/

      - name: Install k3s (if needed)
        run: |
          ssh -i ~/.ssh/lightsail_key -o ServerAliveInterval=30 -o ServerAliveCountMax=10 \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'EOF'
          
          if ! command -v k3s &> /dev/null; then
            echo "Installing k3s..."
            curl -sfL https://get.k3s.io | sh -
            
            # Wait for kubernetes to be ready
            echo "Waiting for k3s to start..."
            sleep 30
            sudo kubectl wait --for=condition=Ready nodes --all --timeout=120s
            
            sudo chmod 644 /etc/rancher/k3s/k3s.yaml
          else
            echo "k3s already installed"
          fi
          EOF

      - name: Deploy to Kubernetes
        run: |
          ssh -i ~/.ssh/lightsail_key -o ServerAliveInterval=30 -o ServerAliveCountMax=10 \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'EOF'
          
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          # Load Docker image into k3s
          echo "Loading image..."
          gunzip -c /tmp/app-image.tar.gz | sudo k3s ctr images import -
          
          # Apply Kubernetes manifests
          echo "Deploying to Kubernetes..."
          sudo kubectl apply -k /tmp/k8s/
          
          # Force rollout to pick up new image
          sudo kubectl rollout restart deployment/backend
          sudo kubectl rollout status deployment/backend --timeout=90s
          
          # Cleanup
          rm /tmp/app-image.tar.gz
          rm -rf /tmp/k8s
          
          echo "✓ Kubernetes deployment complete"
          sudo kubectl get pods
          EOF

      - name: Verify deployment
        run: |
          sleep 15
          curl -f http://${{ secrets.LIGHTSAIL_HOST }}/api/scenarios || exit 1
          echo "✓ Deployment verified"

      - name: Summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ secrets.LIGHTSAIL_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure:** k3s (Kubernetes) + Docker" >> $GITHUB_STEP_SUMMARY